# Project Memory

## OpenPricev7 - MeridianLink QuickPricer Integration

### Project Overview
- **Local Path**: `C:\Users\beach\OpenPricev7`
- **GitHub Repo**: `mortava/OpenPricev7`
- **Live URL**: https://openpricev7.vercel.app
- **Vercel Project**: `james-projects-d94c6754/openpricev7`
- **Stack**: React + Vite + TypeScript + Tailwind CSS
- **Branding**: "OpenBroker AI" with blue accent (#2563eb)

### MeridianLink API Integration
- **OAuth Endpoint**: `https://secure.mortgage.meridianlink.com/oauth/token`
- **SOAP Endpoint**: `https://webservices.mortgage.meridianlink.com/los/webservice/QuickPricer.asmx`
- **Method**: `RunQuickPricerV2`, namespace `http://www.lendersoffice.com/los/webservices/`
- **Auth**: OAuth token prefixed with "Bearer " as SOAP `authorizationTicket`
- **Env Vars**: `MERIDIANLINK_CLIENT_ID`, `MERIDIANLINK_CLIENT_SECRET`

### Key API Mappings (api/get-pricing.ts)
```
Loan Purpose: purchase=1, refinance=2, cashout=2 (both refi types=2 for DSCR)
Occupancy: primary=0, secondary=1, investment=2
Property Type: sfr=1, condo=2, townhouse=3, 2unit=4, 3unit=5, 4unit=6, 5-9unit=7
Income Doc: fullDoc=1, altDoc=2, bankStatement=3, assetDepletion=4, dscr=5, voe=6, noRatio=7
```

### Critical SOAP Field Names (MeridianLink)
```
Non-Warrantable:  sProdIsNonwarrantableProj = true/false  (produces NON-WARRANTABLE -1.000 adj)
Escrow/Impound:   sProdImpoundT = 2 (Taxes & Insurance) | 3 (No Escrow)  (produces ESCROW WAIVER -0.250 adj)
Occupancy Rate:   aOccupancyRate = 100 (hardcoded, hidden from UI, always 100%)
Monthly Income:   sPrimAppTotNonspIPe = 200000 (non-DSCR only, hidden from UI)
Liquid Assets:    sAppTotLiqAsset = 5000000 (all loan types, hidden from UI)
Citizenship:      sCitizenshipResidencyT = 0(US Citizen)|1(Perm Res)|2(Non-Perm Res)|3(Non-Res Alien/Foreign Nat)|4(ITIN)
ITIN flag:        aBTotalScoreIsITIN = true (auto-set when citizenship=4/ITIN)
```
- **WRONG fields** (do NOT use): `aProdNonWarrantable`, `sNonWarrantable`, `sProdImpound` (boolean), `sWillEscrowBeWaived`, `sImpoundTPe`
- **Key lesson**: `sProdImpoundT` is a TYPE SELECT (integer), NOT a boolean. The "T" suffix = type/select field.
- **Key lesson**: `sWillEscrowBeWaived` is a 1008 form field, NOT a pricing engine field.
- **Documentation**: LOXmlFormatDefinition.xml at `secure.lendingqb.com` has standard field definitions.
- **Note**: Many QuickPricer fields (like `aDSCR %`, `aOccupancyRate`) are NOT in standard definition docs.

### Response Parsing
- Double-escaped XML - two passes of `unescapeXml()` needed
- Adjustments in `<AdjustmentsTable>`, mapped by `lLpTemplateId`
- Payment has commas ("2,694.87") - strip before parseFloat
- HTML entities in descriptions - unescape for clean display

### PPP (Prepayment Penalty) Logic
- PPP ONLY for Investment properties
- "0MO PPP"/"0 YR PPP" = NO penalty (OK for all property types)
- DSCR/Investment: Always prefer **5YR PPP (60MO)** - best rates
- `hasPPPInName()` function checks for actual PPP patterns

### UI Behavior (src/App.tsx)
- Default Loan Type: NonQM (hardcoded)
- DSCR Selection: Auto-sets occupancy=Investment, keeps loanType=nonqm
- DSCR-only fields: Housing Expense, Gross Rental Income, DSCR % â€” show ONLY when `documentationType === 'dscr'` (NOT just investment occupancy)
- ZIP Lookup: Zippopotam.us API for auto city/state/county
- Price filter: 99.000-101.000 range, target closest to 100
- Adjustments: Displayed in primary card + per rate option

### Key Files
- `api/get-pricing.ts` - Vercel serverless, SOAP integration
- `src/App.tsx` - React form + results
- `src/lib/PricingLogic.ts` - Pricing utilities
- `src/index.css` - Tailwind theme (primary=#2563eb blue)

### Deploy Commands
```bash
cd /c/Users/beach/OpenPricev7
git add -A && git commit -m "msg" && git push origin master
npx vercel --prod --yes
```

### Test API
```bash
curl -s -X POST "https://openpricev7.vercel.app/api/get-pricing" \
  -H "Content-Type: application/json" \
  -d '{"loanAmount":450000,"propertyValue":600000,"creditScore":740,"propertyZip":"90210","propertyState":"CA","occupancyType":"investment","propertyType":"sfr","loanPurpose":"purchase","documentationType":"dscr","loanType":"nonqm","dscrRatio":">=1.250","lockPeriod":"30"}'
```

---
## Legacy: myprice-master (Original Project)
- **Repo**: `mortava/myprice`, Vercel: `james-projects-d94c6754/myprice-master`
- OpenPricev7 is a full duplicate with enhancements
